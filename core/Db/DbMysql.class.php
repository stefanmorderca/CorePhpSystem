<?php

$t_mysql_reserverd_words = array();
$t_mysql_reserverd_words[] = "ACCESSIBLE";
$t_mysql_reserverd_words[] = "ADD";
$t_mysql_reserverd_words[] = "ALL";
$t_mysql_reserverd_words[] = "ALTER";
$t_mysql_reserverd_words[] = "ANALYZE";
$t_mysql_reserverd_words[] = "AND";
$t_mysql_reserverd_words[] = "AS";
$t_mysql_reserverd_words[] = "ASC";
$t_mysql_reserverd_words[] = "ASENSITIVE";
$t_mysql_reserverd_words[] = "BEFORE";
$t_mysql_reserverd_words[] = "BETWEEN";
$t_mysql_reserverd_words[] = "BIGINT";
$t_mysql_reserverd_words[] = "BINARY";
$t_mysql_reserverd_words[] = "BLOB";
$t_mysql_reserverd_words[] = "BOTH";
$t_mysql_reserverd_words[] = "BY";
$t_mysql_reserverd_words[] = "CALL";
$t_mysql_reserverd_words[] = "CASCADE";
$t_mysql_reserverd_words[] = "CASE";
$t_mysql_reserverd_words[] = "CHANGE";
$t_mysql_reserverd_words[] = "CHAR";
$t_mysql_reserverd_words[] = "CHARACTER";
$t_mysql_reserverd_words[] = "CHECK";
$t_mysql_reserverd_words[] = "COLLATE";
$t_mysql_reserverd_words[] = "COLUMN";
$t_mysql_reserverd_words[] = "CONDITION";
$t_mysql_reserverd_words[] = "CONSTRAINT";
$t_mysql_reserverd_words[] = "CONTINUE";
$t_mysql_reserverd_words[] = "CONVERT";
$t_mysql_reserverd_words[] = "CREATE";
$t_mysql_reserverd_words[] = "CROSS";
$t_mysql_reserverd_words[] = "CURRENT_DATE";
$t_mysql_reserverd_words[] = "CURRENT_TIME";
$t_mysql_reserverd_words[] = "CURRENT_TIMESTAMP";
$t_mysql_reserverd_words[] = "CURRENT_USER";
$t_mysql_reserverd_words[] = "CURSOR";
$t_mysql_reserverd_words[] = "DATABASE";
$t_mysql_reserverd_words[] = "DATABASES";
$t_mysql_reserverd_words[] = "DAY_HOUR";
$t_mysql_reserverd_words[] = "DAY_MICROSECOND";
$t_mysql_reserverd_words[] = "DAY_MINUTE";
$t_mysql_reserverd_words[] = "DAY_SECOND";
$t_mysql_reserverd_words[] = "DEC";
$t_mysql_reserverd_words[] = "DECIMAL";
$t_mysql_reserverd_words[] = "DECLARE";
$t_mysql_reserverd_words[] = "DEFAULT";
$t_mysql_reserverd_words[] = "DELAYED";
$t_mysql_reserverd_words[] = "DELETE";
$t_mysql_reserverd_words[] = "DESC";
$t_mysql_reserverd_words[] = "DESCRIBE";
$t_mysql_reserverd_words[] = "DETERMINISTIC";
$t_mysql_reserverd_words[] = "DISTINCT";
$t_mysql_reserverd_words[] = "DISTINCTROW";
$t_mysql_reserverd_words[] = "DIV";
$t_mysql_reserverd_words[] = "DOUBLE";
$t_mysql_reserverd_words[] = "DROP";
$t_mysql_reserverd_words[] = "DUAL";
$t_mysql_reserverd_words[] = "EACH";
$t_mysql_reserverd_words[] = "ELSE";
$t_mysql_reserverd_words[] = "ELSEIF";
$t_mysql_reserverd_words[] = "ENCLOSED";
$t_mysql_reserverd_words[] = "ESCAPED";
$t_mysql_reserverd_words[] = "EXISTS";
$t_mysql_reserverd_words[] = "EXIT";
$t_mysql_reserverd_words[] = "EXPLAIN";
$t_mysql_reserverd_words[] = "FALSE";
$t_mysql_reserverd_words[] = "FETCH";
$t_mysql_reserverd_words[] = "FLOAT";
$t_mysql_reserverd_words[] = "FLOAT4";
$t_mysql_reserverd_words[] = "FLOAT8";
$t_mysql_reserverd_words[] = "FOR";
$t_mysql_reserverd_words[] = "FORCE";
$t_mysql_reserverd_words[] = "FOREIGN";
$t_mysql_reserverd_words[] = "FROM";
$t_mysql_reserverd_words[] = "FULLTEXT";
$t_mysql_reserverd_words[] = "GRANT";
$t_mysql_reserverd_words[] = "GROUP";
$t_mysql_reserverd_words[] = "HAVING";
$t_mysql_reserverd_words[] = "HIGH_PRIORITY";
$t_mysql_reserverd_words[] = "HOUR_MICROSECOND";
$t_mysql_reserverd_words[] = "HOUR_MINUTE";
$t_mysql_reserverd_words[] = "HOUR_SECOND";
$t_mysql_reserverd_words[] = "IF";
$t_mysql_reserverd_words[] = "IGNORE";
$t_mysql_reserverd_words[] = "IN";
$t_mysql_reserverd_words[] = "INDEX";
$t_mysql_reserverd_words[] = "INFILE";
$t_mysql_reserverd_words[] = "INNER";
$t_mysql_reserverd_words[] = "INOUT";
$t_mysql_reserverd_words[] = "INSENSITIVE";
$t_mysql_reserverd_words[] = "INSERT";
$t_mysql_reserverd_words[] = "INT";
$t_mysql_reserverd_words[] = "INT1";
$t_mysql_reserverd_words[] = "INT2";
$t_mysql_reserverd_words[] = "INT3";
$t_mysql_reserverd_words[] = "INT4";
$t_mysql_reserverd_words[] = "INT8";
$t_mysql_reserverd_words[] = "INTEGER";
$t_mysql_reserverd_words[] = "INTERVAL";
$t_mysql_reserverd_words[] = "INTO";
$t_mysql_reserverd_words[] = "IS";
$t_mysql_reserverd_words[] = "ITERATE";
$t_mysql_reserverd_words[] = "JOIN";
$t_mysql_reserverd_words[] = "KEY";
$t_mysql_reserverd_words[] = "KEYS";
$t_mysql_reserverd_words[] = "KILL";
$t_mysql_reserverd_words[] = "LEADING";
$t_mysql_reserverd_words[] = "LEAVE";
$t_mysql_reserverd_words[] = "LEFT";
$t_mysql_reserverd_words[] = "LIKE";
$t_mysql_reserverd_words[] = "LIMIT";
$t_mysql_reserverd_words[] = "LINEAR";
$t_mysql_reserverd_words[] = "LINES";
$t_mysql_reserverd_words[] = "LOAD";
$t_mysql_reserverd_words[] = "LOCALTIME";
$t_mysql_reserverd_words[] = "LOCALTIMESTAMP";
$t_mysql_reserverd_words[] = "LOCK";
$t_mysql_reserverd_words[] = "LONG";
$t_mysql_reserverd_words[] = "LONGBLOB";
$t_mysql_reserverd_words[] = "LONGTEXT";
$t_mysql_reserverd_words[] = "LOOP";
$t_mysql_reserverd_words[] = "LOW_PRIORITY";
$t_mysql_reserverd_words[] = "MASTER_SSL_VERIFY_SERVER_CERT";
$t_mysql_reserverd_words[] = "MATCH";
$t_mysql_reserverd_words[] = "MAXVALUE";
$t_mysql_reserverd_words[] = "MEDIUMBLOB";
$t_mysql_reserverd_words[] = "MEDIUMINT";
$t_mysql_reserverd_words[] = "MEDIUMTEXT";
$t_mysql_reserverd_words[] = "MIDDLEINT";
$t_mysql_reserverd_words[] = "MINUTE_MICROSECOND";
$t_mysql_reserverd_words[] = "MINUTE_SECOND";
$t_mysql_reserverd_words[] = "MOD";
$t_mysql_reserverd_words[] = "MODIFIES";
$t_mysql_reserverd_words[] = "NATURAL";
$t_mysql_reserverd_words[] = "NOT";
$t_mysql_reserverd_words[] = "NO_WRITE_TO_BINLOG";
$t_mysql_reserverd_words[] = "NULL";
$t_mysql_reserverd_words[] = "NUMERIC";
$t_mysql_reserverd_words[] = "ON";
$t_mysql_reserverd_words[] = "OPTIMIZE";
$t_mysql_reserverd_words[] = "OPTION";
$t_mysql_reserverd_words[] = "OPTIONALLY";
$t_mysql_reserverd_words[] = "OR";
$t_mysql_reserverd_words[] = "ORDER";
$t_mysql_reserverd_words[] = "OUT";
$t_mysql_reserverd_words[] = "OUTER";
$t_mysql_reserverd_words[] = "OUTFILE";
$t_mysql_reserverd_words[] = "PRECISION";
$t_mysql_reserverd_words[] = "PRIMARY";
$t_mysql_reserverd_words[] = "PROCEDURE";
$t_mysql_reserverd_words[] = "PURGE";
$t_mysql_reserverd_words[] = "RANGE";
$t_mysql_reserverd_words[] = "READ";
$t_mysql_reserverd_words[] = "READS";
$t_mysql_reserverd_words[] = "READ_WRITE";
$t_mysql_reserverd_words[] = "REAL";
$t_mysql_reserverd_words[] = "REFERENCES";
$t_mysql_reserverd_words[] = "REGEXP";
$t_mysql_reserverd_words[] = "RELEASE";
$t_mysql_reserverd_words[] = "RENAME";
$t_mysql_reserverd_words[] = "REPEAT";
$t_mysql_reserverd_words[] = "REPLACE";
$t_mysql_reserverd_words[] = "REQUIRE";
$t_mysql_reserverd_words[] = "RESIGNAL";
$t_mysql_reserverd_words[] = "RESTRICT";
$t_mysql_reserverd_words[] = "RETURN";
$t_mysql_reserverd_words[] = "REVOKE";
$t_mysql_reserverd_words[] = "RIGHT";
$t_mysql_reserverd_words[] = "RLIKE";
$t_mysql_reserverd_words[] = "SCHEMA";
$t_mysql_reserverd_words[] = "SCHEMAS";
$t_mysql_reserverd_words[] = "SECOND_MICROSECOND";
$t_mysql_reserverd_words[] = "SELECT";
$t_mysql_reserverd_words[] = "SENSITIVE";
$t_mysql_reserverd_words[] = "SEPARATOR";
$t_mysql_reserverd_words[] = "SET";
$t_mysql_reserverd_words[] = "SHOW";
$t_mysql_reserverd_words[] = "SIGNAL";
$t_mysql_reserverd_words[] = "SMALLINT";
$t_mysql_reserverd_words[] = "SPATIAL";
$t_mysql_reserverd_words[] = "SPECIFIC";
$t_mysql_reserverd_words[] = "SQL";
$t_mysql_reserverd_words[] = "SQLEXCEPTION";
$t_mysql_reserverd_words[] = "SQLSTATE";
$t_mysql_reserverd_words[] = "SQLWARNING";
$t_mysql_reserverd_words[] = "SQL_BIG_RESULT";
$t_mysql_reserverd_words[] = "SQL_CALC_FOUND_ROWS";
$t_mysql_reserverd_words[] = "SQL_SMALL_RESULT";
$t_mysql_reserverd_words[] = "SSL";
$t_mysql_reserverd_words[] = "STARTING";
$t_mysql_reserverd_words[] = "STRAIGHT_JOIN";
$t_mysql_reserverd_words[] = "TABLE";
$t_mysql_reserverd_words[] = "TERMINATED";
$t_mysql_reserverd_words[] = "THEN";
$t_mysql_reserverd_words[] = "TINYBLOB";
$t_mysql_reserverd_words[] = "TINYINT";
$t_mysql_reserverd_words[] = "TINYTEXT";
$t_mysql_reserverd_words[] = "TO";
$t_mysql_reserverd_words[] = "TRAILING";
$t_mysql_reserverd_words[] = "TRIGGER";
$t_mysql_reserverd_words[] = "TRUE";
$t_mysql_reserverd_words[] = "UNDO";
$t_mysql_reserverd_words[] = "UNION";
$t_mysql_reserverd_words[] = "UNIQUE";
$t_mysql_reserverd_words[] = "UNLOCK";
$t_mysql_reserverd_words[] = "UNSIGNED";
$t_mysql_reserverd_words[] = "UPDATE";
$t_mysql_reserverd_words[] = "USAGE";
$t_mysql_reserverd_words[] = "USE";
$t_mysql_reserverd_words[] = "USING";
$t_mysql_reserverd_words[] = "UTC_DATE";
$t_mysql_reserverd_words[] = "UTC_TIME";
$t_mysql_reserverd_words[] = "UTC_TIMESTAMP";
$t_mysql_reserverd_words[] = "VALUES";
$t_mysql_reserverd_words[] = "VARBINARY";
$t_mysql_reserverd_words[] = "VARCHAR";
$t_mysql_reserverd_words[] = "VARCHARACTER";
$t_mysql_reserverd_words[] = "VARYING";
$t_mysql_reserverd_words[] = "WHEN";
$t_mysql_reserverd_words[] = "WHERE";
$t_mysql_reserverd_words[] = "WHILE";
$t_mysql_reserverd_words[] = "WITH";
$t_mysql_reserverd_words[] = "WRITE";
$t_mysql_reserverd_words[] = "XOR";
$t_mysql_reserverd_words[] = "YEAR_MONTH";
$t_mysql_reserverd_words[] = "ZEROFILL";

include_once 'DbInterface.class.php';

class DbMysql implements DbInterface {

    static function connect($host, $user, $pass) {
        $resource = mysqli_connect($host, $user, $pass);

        return $resource;
    }

    static function selectDB($dbname, $t_connection) {
        if (mysqli_select_db($dbname, $t_connection['conn'])) {
            return true;
        } else {
            return false;
        }
    }

    static function setCharset($charset, $t_connection) {
        if (mysqli_set_charset($charset, $t_connection['conn'])) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * Tu są 3 przypadki/sposoby obsłużenia odpowiedzi
     *
     * 1. Odbieramy dane z bazy mysqli_fetch_assoc, mysqli_fetch_row, mysqli_fetch_array 
     * 	Wszystko można obsłużyć za pomocą mysqli_fetch_assoc
     *
     * 2. Poszedł insert - przydało by się pobrać last_insert_id mysqli_insert_id
     *
     * 3. DELETE, UPDATE - wystarczy policzyć ilość zmienionych wpisów mysqli_affected_rows
     *
     * PS: 	CREATE TABLE/DATABASE zwraca 1 affected rows, lub error z jakąś tam wiadomością
     * 	DESC TABLE, SHOW TABLE/DATABASE/PROCESSLIST to zwykły select
     *
     * 	Jeżeli $last_insert,$ile,$result === false znaczy jest bug 
     * 	Jeżeli $last_insert = 0 - znaczy nie było inserta
     * 	Jeżeli $ile = 0 - wykonało się ale nic się nie stało     
     * 
     * @param type $query
     * @param type $t_connection
     * @return type
     */
    static function query($query, $t_connection) {
        $result = mysqli_query($query, $t_connection['conn']);

        if ($result === null || $result === false) {
            //TODO: Zapisz jakos ten blad itp rzuć wyjątekiem - wogóle to najlepiej zwróć wyjątek
            $echo = $query . "\n";
            $echo .= mysqli_error($t_connection['conn']) . "\n";

            throw new Exception($echo);
        }

        $t_output = array();

        if (!is_bool($result)) {
            while ($t_tmp = mysqli_fetch_assoc($result)) {
                $t_output[] = $t_tmp;
            }
        }

        $last_insert = mysqli_insert_id($t_connection['conn']);

        if (!is_bool($result)) {
            $ile = mysqli_num_rows($result); // for SELECT 
        } else {
            $ile = mysqli_affected_rows($t_connection['conn']); // for INSERT, UPDATE, REPLACE or DELETE
        }

        return array($t_output, $ile, $last_insert);
    }

}
